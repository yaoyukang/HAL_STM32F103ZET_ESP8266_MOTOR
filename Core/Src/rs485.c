#include "rs485.h"
#include "usart.h"
 
uint8_t RS485_RX_BUF[64];  	
uint8_t RS485_RX_CNT=0;  
extern uint8_t Rx485;

//uint8_t Delta_flag = 0;
////01-10-00-08-00-05-0A-00-00-00-00-ED-A4-00-00-06-00-6D-34
//uint8_t point1[] = {0x01,0x10,0x00,0x08,0x00,0x05,0x0A,0x00,0x00,0x00,0x00,0xED,0xA4,0x00,0x00,0x06,0x00,0x6D,0x34};
////01-10-00-08-00-05-0A-00-00-00-00-EC-78-00-00-06-00-BD-36 初始点 
//uint8_t point2[] = {0x01,0x10,0x00,0x08,0x00,0x05,0x0A,0x00,0x00,0x00,0x00,0xE8,0x90,0x00,0x00,0x06,0x00,0xDC,0xA5};
////01-10-00-08-00-05-0A-00-00-00-00-E8-90-00-00-06-00-DC-A5  -600 点
//uint8_t point3[] = {0x01,0x10,0x00,0x08,0x00,0x05,0x0A,0x00,0x00,0x07,0xD0,0xE8,0x90,0x00,0x00,0x06,0x00,0x4C,0x8E};
//	//01-10-00-08-00-05-0A-00-00-07-D0-E8-90-00-00-06-00-4C-8E   200点
//uint8_t point4[] = {0x01,0x10,0x00,0x08,0x00,0x05,0x0A,0x00,0x00,0xF8,0x30,0xEC,0x78,0x00,0x00,0x06,0x00,0x83,0xD7};
//	//-200点
//uint8_t point5[] = {0x01,0x10,0x00,0x08,0x00,0x05,0x0A,0xF5,0x74,0x00,0x00,0xEA,0x20,0x00,0x00,0x01,0x00,0xDC,0x7C};

void RS485_Init(void)
{
	RS485_RX_EN;			
	HAL_UART_Receive_IT(&huart2,&Rx485,1);
}

void RS485_Send_Data(uint8_t *buf,uint8_t len)
{
	RS485_TX_EN;			
	HAL_UART_Transmit(&huart2,buf,len,1000);
	RS485_RX_CNT=0;	  
	RS485_RX_EN;				
}
void RS485_Receive_Data(uint8_t *buf,uint8_t *len)
{
	uint8_t rxlen=RS485_RX_CNT;
	uint8_t i=0;
	*len=0;				//默认为0
	HAL_Delay(10);		//等待10ms,连续超过10ms没有接收到一个数据,则认为接收结束
	if(rxlen==RS485_RX_CNT&&rxlen)//接收到了数据,且接收完成了
	{
		for(i=0;i<rxlen;i++)
		{
			buf[i]=RS485_RX_BUF[i];	
		}		
		*len=RS485_RX_CNT;	//记录本次数据长度
		RS485_RX_CNT=0;		//清零
	}
} 




